<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover"
    />
    <title>NeonRx ¬∑ dark prescription vault</title>
    <!-- Font Awesome 6 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- PDF.js (light) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
      /* ----- DARK MODE, MOBILE-FIRST, ZERO LIGHT THEME ----- */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        background: #0b0f17; /* deep dark background */
        font-family:
          'Inter',
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          Roboto,
          sans-serif;
        color: #eef2fb;
        line-height: 1.45;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overscroll-behavior: none;
      }

      /* design tokens ‚Äì pure dark */
      :root {
        --bg-dark: #0b0f17;
        --surface-dark: #151e2c;
        --surface-raised: #1e2a3a;
        --border-dim: #2a3647;
        --primary-glow: #2b7fff;
        --primary-soft: #3b82f6;
        --accent-purple: #a78bfa;
        --accent-pink: #f472b6;
        --success-teal: #2dd4bf;
        --warning-amber: #fbbf24;
        --danger-rose: #f87171;
        --text-main: #eef2fb;
        --text-muted: #94a3b8;
        --shadow-card:
          0 15px 30px -10px rgba(0, 0, 0, 0.7),
          0 0 0 1px rgba(43, 127, 255, 0.1);
        --radius-lg: 28px;
        --radius-md: 20px;
        --radius-sm: 16px;
      }

      /* main app container ‚Äì centered, mobile max-width 480px */
      .app {
        max-width: 480px;
        width: 100%;
        margin: 0 auto;
        background: var(--bg-dark);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        position: relative;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
      }

      /* header ‚Äì glassy dark */
      .header {
        background: rgba(21, 30, 44, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 18px 20px 10px 20px;
        border-bottom: 1px solid var(--border-dim);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 0 0 32px 32px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
      }

      .header h1 {
        font-size: 1.8rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        background: linear-gradient(150deg, #90caf9, #c084fc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-actions {
        display: flex;
        gap: 12px;
      }

      .header-actions button {
        background: #1f2b3c;
        border: none;
        font-size: 1.3rem;
        color: var(--text-muted);
        width: 44px;
        height: 44px;
        border-radius: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        transition: 0.1s;
      }

      .header-actions button:active {
        background: #2b3b52;
        transform: scale(0.94);
      }

      /* main scrollable content */
      .main-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 20px 16px 90px 16px;
        -webkit-overflow-scrolling: touch;
      }

      /* bottom navigation (dark) */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-width: 480px;
        margin: 0 auto;
        background: rgba(21, 30, 44, 0.9);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        display: flex;
        justify-content: space-around;
        padding: 8px 12px 22px;
        border-top: 1px solid #253141;
        box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.7);
        z-index: 20;
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        background: transparent;
        border: none;
        font-size: 0.7rem;
        color: var(--text-muted);
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 40px;
        width: 64px;
        transition: 0.1s;
      }

      .nav-item i {
        font-size: 1.5rem;
        margin-bottom: 2px;
      }

      .nav-item.active {
        color: var(--primary-soft);
        background: #1e2f44;
      }

      /* cards ‚Äì dark elevated */
      .card {
        background: var(--surface-dark);
        border-radius: var(--radius-lg);
        padding: 22px 18px;
        margin-bottom: 18px;
        box-shadow: var(--shadow-card);
        border: 1px solid rgba(43, 127, 255, 0.15);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .card-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #d9e2f5;
      }

      /* stats */
      .stat-row {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
      }

      .stat-badge {
        background: #1f2b3c;
        border-radius: 50px;
        padding: 14px 20px;
        flex: 1 1 40%;
        display: flex;
        align-items: center;
        gap: 14px;
        border: 1px solid #31445c;
      }

      .stat-badge i {
        font-size: 2rem;
        color: var(--primary-soft);
      }

      .stat-badge span {
        font-weight: 650;
        font-size: 1.6rem;
        line-height: 1.2;
        color: white;
      }

      .stat-badge small {
        color: var(--text-muted);
        font-size: 0.85rem;
      }

      /* progress bar */
      .progress-section {
        margin: 16px 0 6px;
      }
      .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      .progress-bar {
        height: 12px;
        background: #1e2a3a;
        border-radius: 30px;
        margin-top: 8px;
        overflow: hidden;
        border: 1px solid #31445c;
      }
      .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #2b7fff, #9d7bf5);
        border-radius: 30px;
        transition: width 0.3s;
        box-shadow: 0 0 8px #2b7fff;
      }

      /* file list item */
      .file-grid {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .file-item {
        background: #1a2435;
        border-radius: 24px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 14px;
        border: 1px solid #2d3f58;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
      }

      .file-item:active {
        background: #23304a;
      }

      .file-icon {
        width: 52px;
        height: 52px;
        background: #12223b;
        border-radius: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: #6b9eff;
        flex-shrink: 0;
        border: 1px solid #3f5680;
      }

      .file-details {
        flex: 1;
      }

      .file-details h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: #edf4ff;
      }

      .file-meta {
        display: flex;
        gap: 16px;
        font-size: 0.8rem;
        color: #8599bb;
      }

      .file-actions {
        display: flex;
        gap: 4px;
      }

      .file-actions button,
      .file-actions a {
        background: transparent;
        border: none;
        width: 42px;
        height: 42px;
        border-radius: 30px;
        color: #b1c6e9;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .file-actions button:active {
        background: #2f4160;
      }

      /* FAB */
      .fab {
        position: fixed;
        bottom: 100px;
        right: max(16px, calc(50% - 200px));
        width: 64px;
        height: 64px;
        border-radius: 40px;
        background: #2563eb;
        border: none;
        box-shadow:
          0 8px 22px #1e3a8a,
          0 0 15px #3b82f6;
        color: white;
        font-size: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 25;
        transition: 0.12s;
      }

      .fab:active {
        transform: scale(0.88);
        background: #3b82f6;
      }

      /* modals ‚Äì dark sheets */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        z-index: 100;
      }

      .modal-sheet {
        background: #1a2537;
        width: 100%;
        max-width: 480px;
        border-radius: 36px 36px 0 0;
        padding: 24px 22px 36px;
        box-shadow: 0 -20px 50px rgba(0, 0, 0, 0.8);
        border-top: 1px solid #3f5680;
        animation: slideUp 0.2s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .modal-header h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #bdd3ff;
      }

      .close-btn {
        background: #273850;
        border: none;
        font-size: 1.4rem;
        width: 48px;
        height: 48px;
        border-radius: 40px;
        color: #afc7f0;
      }

      /* inputs */
      input,
      select,
      textarea {
        width: 100%;
        padding: 18px 18px;
        border: 1.5px solid #31476b;
        border-radius: 34px;
        font-size: 1rem;
        background: #0f1a2b;
        color: #f0f4ff;
        margin-bottom: 18px;
      }

      input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
      }

      label {
        font-weight: 550;
        margin-bottom: 6px;
        display: block;
        color: #b8cef0;
        font-size: 0.95rem;
      }

      .btn {
        background: #2563eb;
        color: white;
        border: none;
        padding: 18px 24px;
        border-radius: 50px;
        font-weight: 650;
        font-size: 1.1rem;
        width: 100%;
        box-shadow: 0 8px 24px #1e3f8f;
        transition: 0.1s;
      }

      .btn:active {
        opacity: 0.75;
        transform: scale(0.97);
      }

      .btn-outline {
        background: transparent;
        border: 2px solid #3f5680;
        color: #e2ecff;
        box-shadow: none;
      }

      /* auth screen */
      .auth-container {
        padding: 30px 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 100vh;
        background: #0e1623;
      }

      .pill-logo {
        font-size: 4rem;
        text-align: center;
        margin-bottom: 20px;
        color: #4b7eff;
        filter: drop-shadow(0 0 12px #2b7fff);
      }

      .hidden {
        display: none !important;
      }

      /* toast */
      .toast-message {
        position: fixed;
        bottom: 130px;
        left: 20px;
        right: 20px;
        max-width: 400px;
        margin: 0 auto;
        background: #253c5c;
        color: white;
        padding: 14px 24px;
        border-radius: 60px;
        text-align: center;
        font-weight: 500;
        box-shadow: 0 12px 30px black;
        z-index: 200;
        border: 1px solid #5f7eb0;
      }

      /* preview */
      .pdf-canvas {
        max-width: 100%;
        height: auto;
        border-radius: 24px;
        background: #0f1a2f;
        border: 1px solid #45658d;
      }

      .preview-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }
      .preview-controls button {
        background: #273f60;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 40px;
        font-size: 1.3rem;
        color: white;
      }

      a {
        text-decoration: none;
        color: #7aa5ff;
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <!-- header -->
      <div class="header" id="mainHeader">
        <h1 id="headerTitle">NeonRx</h1>
        <div class="header-actions">
          <button id="searchToggleBtn" aria-label="search">
            <i class="fas fa-search"></i>
          </button>
          <button id="refreshBtn" aria-label="refresh">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </div>

      <!-- main scroll -->
      <div class="main-scroll" id="mainContent">
        <!-- AUTH (dark) -->
        <div id="authView" class="auth-container">
          <div class="pill-logo">
            <i class="fas fa-prescription-bottle"></i>
          </div>
          <!-- login form -->
          <div id="loginForm">
            <label>Email</label
            ><input
              type="email"
              id="loginEmail"
              placeholder="doctor@neonrx.com"
              value="demo@pill.com"
            />
            <label>Password</label
            ><input
              type="password"
              id="loginPassword"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              value="demo123"
            />
            <button class="btn" id="loginBtn">
              <i class="fas fa-sign-in-alt" style="margin-right: 8px"></i> log
              in
            </button>
            <p style="text-align: center; margin-top: 24px">
              <a href="#" id="showForgotLink">reset</a> ¬† ‚Ä¢ ¬†
              <a href="#" id="showSignupLink">sign up</a>
            </p>
          </div>
          <!-- signup form -->
          <div id="signupForm" class="hidden">
            <label>Email</label
            ><input type="email" id="signupEmail" placeholder="new@dark.com" />
            <label>Password</label
            ><input
              type="password"
              id="signupPassword"
              placeholder="min 6 chars"
            />
            <button class="btn" id="signupBtn">create account</button>
            <p style="margin-top: 20px">
              <a href="#" id="backToLoginLink">‚Üê back to login</a>
            </p>
          </div>
          <!-- forgot form (dev token visible) -->
          <div id="forgotForm" class="hidden">
            <label>Email for reset</label
            ><input
              type="email"
              id="forgotEmail"
              placeholder="your@email.com"
            />
            <button class="btn" id="forgotBtn">send reset link</button>
            <p style="margin-top: 16px">
              <a href="#" id="backToLoginFromForgot">‚Üê back</a>
            </p>
            <div
              id="resetDevNotice"
              class="hidden"
              style="
                background: #1f2e44;
                border-radius: 30px;
                padding: 16px;
                margin-top: 16px;
              "
            >
              <p style="color: #b3d0ff">üîê dev token:</p>
              <textarea
                id="resetTokenDummy"
                rows="2"
                readonly
                style="
                  background: #0f1a2b;
                  color: #b3d0ff;
                  border: 1px solid #3f5e88;
                "
              ></textarea>
            </div>
          </div>
        </div>

        <!-- DASHBOARD (hidden until auth) -->
        <div id="dashboardView" class="hidden">
          <!-- overview section -->
          <div id="overviewSection">
            <div class="card">
              <div class="card-header">
                <h2><i class="fas fa-database"></i> storage</h2>
                <span id="storagePercent">0%</span>
              </div>
              <div class="progress-section">
                <div class="progress-label">
                  <span>used</span> <span id="usedStorageText">0 MB</span>
                </div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="storageFill"
                    style="width: 0%"
                  ></div>
                </div>
              </div>
              <div class="stat-row" style="margin-top: 16px">
                <div class="stat-badge">
                  <i class="fas fa-file-prescription"></i>
                  <span id="totalFilesCount">0</span> <small>scripts</small>
                </div>
                <div class="stat-badge">
                  <i class="fas fa-user-md"></i>
                  <span id="uniqueDocsCount">0</span> <small>doctors</small>
                </div>
              </div>
            </div>
            <div class="card">
              <h2 style="margin-bottom: 12px">
                <i class="fas fa-history"></i> recent
              </h2>
              <div id="recentFilePreview" style="color: #a0bbdf">none</div>
            </div>
            <div style="display: flex; gap: 12px; margin-bottom: 10px">
              <button class="btn-outline" style="flex: 1" id="quickUpload">
                <i class="fas fa-cloud-upload-alt"></i> upload
              </button>
              <button class="btn-outline" style="flex: 1" id="quickExport">
                <i class="fas fa-file-export"></i> export
              </button>
            </div>
          </div>

          <!-- files section -->
          <div id="filesSection" class="hidden">
            <div
              style="
                display: flex;
                gap: 10px;
                align-items: center;
                margin-bottom: 18px;
              "
            >
              <input
                type="text"
                id="fileSearchInput"
                placeholder="üîç search doctor, date"
                style="margin-bottom: 0; flex: 1"
              />
              <select
                id="sortSelect"
                style="
                  width: auto;
                  margin-bottom: 0;
                  padding: 16px 10px;
                  border-radius: 40px;
                  background: #1a2537;
                  color: white;
                "
              >
                <option value="date-desc">newest</option>
                <option value="date-asc">oldest</option>
                <option value="name-asc">A-Z</option>
                <option value="name-desc">Z-A</option>
              </select>
            </div>
            <div id="filesContainer" class="file-grid"></div>
          </div>

          <!-- doctors section -->
          <div id="doctorsSection" class="hidden">
            <h2 style="margin-bottom: 16px">
              <i class="fas fa-stethoscope" style="color: #9bbaff"></i> your
              doctors
            </h2>
            <div id="doctorsListContainer" class="file-grid"></div>
          </div>

          <!-- settings section (with reset using token) -->
          <div id="settingsSection" class="hidden">
            <div class="card">
              <h2><i class="fas fa-user-astronaut"></i> account</h2>
              <p id="settingsEmail" style="color: #b3d0ff">user@neonrx.com</p>
              <button
                class="btn-outline"
                style="margin-top: 12px"
                id="logoutBtn"
              >
                log out
              </button>
            </div>
            <div class="card">
              <h2>reset with token</h2>
              <input
                type="text"
                id="settingsToken"
                placeholder="paste reset token"
              />
              <input
                type="password"
                id="settingsNewPwd"
                placeholder="new password"
              />
              <button class="btn" id="settingsChangePwdBtn">
                change password
              </button>
            </div>
            <div class="card">
              <button
                class="btn-outline"
                style="color: #fca5a5; border-color: #a15555"
                id="dangerClearAll"
              >
                delete all files
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- bottom navigation (dashboard) -->
      <div class="bottom-nav hidden" id="bottomNav">
        <button class="nav-item" data-section="overview">
          <i class="fas fa-home"></i><span>home</span>
        </button>
        <button class="nav-item" data-section="files">
          <i class="fas fa-file-lines"></i><span>files</span>
        </button>
        <button class="nav-item" data-section="doctors">
          <i class="fas fa-user-md"></i><span>doctors</span>
        </button>
        <button class="nav-item" data-section="settings">
          <i class="fas fa-gear"></i><span>settings</span>
        </button>
      </div>

      <!-- FAB upload -->
      <button class="fab hidden" id="fabUpload">
        <i class="fas fa-plus"></i>
      </button>

      <!-- UPLOAD MODAL -->
      <div
        id="uploadModal"
        class="modal-overlay hidden"
        onclick="closeModal('uploadModal')"
      >
        <div class="modal-sheet" onclick="event.stopPropagation()">
          <div class="modal-header">
            <h3>upload script</h3>
            <button class="close-btn" onclick="closeModal('uploadModal')">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <form id="uploadForm">
            <label>doctor</label
            ><input type="text" id="uploadDoctor" required /> <label>date</label
            ><input type="date" id="uploadDate" required />
            <label>file (‚â§5MB)</label>
            <div
              style="
                border: 2px dashed #3f5680;
                border-radius: 40px;
                padding: 20px;
                text-align: center;
                margin-bottom: 16px;
              "
            >
              <input
                type="file"
                id="uploadFileInput"
                accept=".pdf,.jpg,.jpeg,.png"
                style="display: none"
              />
              <button
                type="button"
                id="simulateFileClick"
                style="
                  background: none;
                  border: none;
                  width: 100%;
                  color: #b3d0ff;
                "
              >
                <i
                  class="fas fa-cloud-upload-alt"
                  style="font-size: 2.5rem; color: #5f8aff"
                ></i
                ><br /><span id="fileNameDisplay">select file</span>
              </button>
            </div>
            <button type="submit" class="btn">upload</button>
          </form>
        </div>
      </div>

      <!-- EDIT MODAL -->
      <div
        id="editModal"
        class="modal-overlay hidden"
        onclick="closeModal('editModal')"
      >
        <div class="modal-sheet" onclick="event.stopPropagation()">
          <div class="modal-header">
            <h3>edit entry</h3>
            <button class="close-btn" onclick="closeModal('editModal')">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <form id="editForm">
            <input type="hidden" id="editId" />
            <label>doctor</label><input type="text" id="editDoctor" required />
            <label>date</label><input type="date" id="editDate" required />
            <button type="submit" class="btn">update</button>
          </form>
        </div>
      </div>

      <!-- PREVIEW MODAL -->
      <div
        id="previewModal"
        class="modal-overlay hidden"
        onclick="closeModal('previewModal')"
      >
        <div
          class="modal-sheet"
          style="max-height: 80vh; overflow-y: auto"
          onclick="event.stopPropagation()"
        >
          <div class="modal-header">
            <h3 id="previewFilename">file</h3>
            <button class="close-btn" onclick="closeModal('previewModal')">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div
            id="previewContent"
            style="min-height: 200px; text-align: center; color: #b3d0ff"
          >
            <i class="fas fa-spinner fa-pulse"></i>
          </div>
          <div class="preview-controls" id="pdfControls" style="display: none">
            <button id="prevPageBtn"><i class="fas fa-chevron-left"></i></button
            ><span id="pageInfo" style="color: white">1/1</span
            ><button id="nextPageBtn">
              <i class="fas fa-chevron-right"></i>
            </button>
            <button id="rotateLeftBtn"><i class="fas fa-undo-alt"></i></button
            ><button id="rotateRightBtn">
              <i class="fas fa-redo-alt"></i>
            </button>
          </div>
          <div style="margin-top: 16px">
            <a
              id="downloadPreviewBtn"
              class="btn-outline"
              style="display: block; text-align: center; padding: 14px"
              download
              >download</a
            >
          </div>
        </div>
      </div>

      <!-- TOAST -->
      <div id="toast" class="toast-message hidden">message</div>
    </div>

    <script>
      (function () {
        // ----- DARK MODE + FULL BACKEND INTEGRATION (exact server endpoints) -----
        const API_URL = 'http://localhost:3000'; // change to deployed vercel if needed
        let allFiles = [];
        let currentUser = null;
        let currentSection = 'overview';
        let pdfDoc = null,
          currentPage = 1,
          currentRotation = 0,
          currentPreviewId = null;
        const STORAGE_LIMIT = 100 * 1024 * 1024; // 100 MB

        // DOM elements
        const authView = document.getElementById('authView');
        const dashboardView = document.getElementById('dashboardView');
        const bottomNav = document.getElementById('bottomNav');
        const fab = document.getElementById('fabUpload');
        const headerTitle = document.getElementById('headerTitle');

        // helpers
        function showToast(msg, type = 'info') {
          const t = document.getElementById('toast');
          t.textContent = msg;
          t.classList.remove('hidden');
          setTimeout(() => t.classList.add('hidden'), 2800);
        }
        function formatBytes(b) {
          if (b == 0) return '0 B';
          const k = 1024,
            i = Math.floor(Math.log(b) / Math.log(k));
          return (
            parseFloat((b / Math.pow(k, i)).toFixed(1)) +
            ' ' +
            ['B', 'KB', 'MB'][i]
          );
        }
        function formatDate(iso) {
          return new Date(iso).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
          });
        }

        // api request with token (your backend uses simple auth without Bearer, but we keep header)
        async function apiReq(
          endpoint,
          method = 'GET',
          body = null,
          formData = false,
        ) {
          const opts = { method };
          if (!formData) opts.headers = { 'Content-Type': 'application/json' };
          if (body) opts.body = formData ? body : JSON.stringify(body);
          const token = localStorage.getItem('token'); // not used in your backend, but keep for future
          // but your server doesn't require token. we pass userId via query/body.
          const res = await fetch(API_URL + endpoint, opts);
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'request failed');
          return data;
        }

        // check auth (simple)
        function checkAuth() {
          const uid = localStorage.getItem('userId');
          const email = localStorage.getItem('userEmail');
          const urlParams = new URLSearchParams(location.search);
          const resetToken = urlParams.get('token');
          if (resetToken) {
            alert(
              'Token detected: ' +
                resetToken +
                ' ‚Äî you can use it in settings.',
            );
            history.replaceState(null, '', location.pathname);
          }
          if (uid && email) {
            currentUser = { id: uid, email };
            showDashboard();
            loadFiles();
          } else showAuth();
        }

        function showAuth() {
          authView.classList.remove('hidden');
          dashboardView.classList.add('hidden');
          bottomNav.classList.add('hidden');
          fab.classList.add('hidden');
          document.getElementById('loginForm').classList.remove('hidden');
          document.getElementById('signupForm').classList.add('hidden');
          document.getElementById('forgotForm').classList.add('hidden');
        }

        function showDashboard() {
          authView.classList.add('hidden');
          dashboardView.classList.remove('hidden');
          bottomNav.classList.remove('hidden');
          fab.classList.remove('hidden');
          switchSection('overview');
          document.getElementById('settingsEmail').innerText =
            localStorage.getItem('userEmail') || 'user';
        }

        function switchSection(section) {
          currentSection = section;
          ['overview', 'files', 'doctors', 'settings'].forEach((s) =>
            document.getElementById(s + 'Section').classList.add('hidden'),
          );
          document
            .getElementById(section + 'Section')
            .classList.remove('hidden');
          document
            .querySelectorAll('.nav-item')
            .forEach((b) => b.classList.remove('active'));
          document
            .querySelector(`.nav-item[data-section="${section}"]`)
            .classList.add('active');
          headerTitle.innerText =
            section === 'overview'
              ? 'NeonRx'
              : section === 'files'
                ? 'scripts'
                : section === 'doctors'
                  ? 'doctors'
                  : 'settings';
          if (section === 'files') renderFiles();
          if (section === 'doctors') renderDoctors();
          if (section === 'overview') updateStorageUI();
        }

        async function loadFiles() {
          const uid = localStorage.getItem('userId');
          if (!uid) return;
          try {
            const files = await apiReq(`/files?userId=${uid}`);
            allFiles = files.map((f) => ({ ...f, size: f.size || 0 }));
            updateStorageUI();
            renderFiles();
            renderDoctors();
          } catch (e) {
            showToast('error loading files', 'error');
          }
        }

        function updateStorageUI() {
          const totalBytes = allFiles.reduce((s, f) => s + (f.size || 0), 0);
          const percent = Math.min(100, (totalBytes / STORAGE_LIMIT) * 100);
          document.getElementById('storageFill').style.width = percent + '%';
          document.getElementById('storagePercent').innerText =
            Math.round(percent) + '%';
          document.getElementById('usedStorageText').innerText =
            formatBytes(totalBytes);
          document.getElementById('totalFilesCount').innerText =
            allFiles.length;
          const docs = new Set(allFiles.map((f) => f.doctor)).size;
          document.getElementById('uniqueDocsCount').innerText = docs;
          if (allFiles.length) {
            const recent = allFiles.sort(
              (a, b) => new Date(b.date) - new Date(a.date),
            )[0];
            document.getElementById('recentFilePreview').innerHTML =
              `<i class="fas fa-file"></i> ${recent.doctor} ¬∑ ${formatDate(recent.date)}`;
          } else
            document.getElementById('recentFilePreview').innerHTML = 'no files';
        }

        function renderFiles() {
          const container = document.getElementById('filesContainer');
          let filtered = [...allFiles];
          const search = document
            .getElementById('fileSearchInput')
            ?.value.toLowerCase();
          if (search)
            filtered = filtered.filter(
              (f) =>
                f.doctor.toLowerCase().includes(search) ||
                f.filename?.toLowerCase().includes(search) ||
                f.date.includes(search),
            );
          const sort =
            document.getElementById('sortSelect')?.value || 'date-desc';
          if (sort === 'date-desc')
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
          else if (sort === 'date-asc')
            filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
          else if (sort === 'name-asc')
            filtered.sort((a, b) => a.doctor.localeCompare(b.doctor));
          else if (sort === 'name-desc')
            filtered.sort((a, b) => b.doctor.localeCompare(a.doctor));
          if (!filtered.length) {
            container.innerHTML =
              '<div class="card" style="text-align:center">no scripts</div>';
            return;
          }
          container.innerHTML = '';
          filtered.forEach((f) => {
            const icon = f.contentType?.startsWith('image')
              ? 'fa-file-image'
              : f.contentType === 'application/pdf'
                ? 'fa-file-pdf'
                : 'fa-file-lines';
            const card = document.createElement('div');
            card.className = 'file-item';
            card.innerHTML = `<div class="file-icon"><i class="fas ${icon}"></i></div>
          <div class="file-details"><h3>${f.doctor || '?'}</h3><div class="file-meta"><span>${formatDate(f.date)}</span><span>${formatBytes(f.size || 0)}</span></div></div>
          <div class="file-actions">
            <button onclick="previewFile('${f.id}')"><i class="fas fa-eye"></i></button>
            <a href="${API_URL}/file/${f.id}" download="${f.filename}" target="_blank"><i class="fas fa-download"></i></a>
            <button onclick="openEditModal('${f.id}','${f.doctor}','${f.date}')"><i class="fas fa-pen"></i></button>
            <button onclick="deleteFile('${f.id}')"><i class="fas fa-trash"></i></button>
          </div>`;
            container.appendChild(card);
          });
        }

        function renderDoctors() {
          const container = document.getElementById('doctorsListContainer');
          if (!allFiles.length) {
            container.innerHTML = '<div class="card">no doctors</div>';
            return;
          }
          const counts = allFiles.reduce((acc, f) => {
            acc[f.doctor] = (acc[f.doctor] || 0) + 1;
            return acc;
          }, {});
          container.innerHTML = '';
          Object.entries(counts)
            .sort((a, b) => b[1] - a[1])
            .forEach(([doc, cnt]) => {
              const div = document.createElement('div');
              div.className = 'file-item';
              div.innerHTML = `<div class="file-icon" style="color:#9bbaff;"><i class="fas fa-user-md"></i></div><div><h3>${doc}</h3><span class="file-meta">${cnt} file${cnt > 1 ? 's' : ''}</span></div>`;
              container.appendChild(div);
            });
        }

        // file operations
        window.deleteFile = async (id) => {
          if (!confirm('Delete forever?')) return;
          try {
            await apiReq(`/file/${id}`, 'DELETE');
            showToast('deleted');
            await loadFiles();
          } catch (e) {
            showToast('error', 'error');
          }
        };
        window.openEditModal = (id, doctor, date) => {
          document.getElementById('editId').value = id;
          document.getElementById('editDoctor').value = doctor;
          document.getElementById('editDate').value = date;
          document.getElementById('editModal').classList.remove('hidden');
        };
        document
          .getElementById('editForm')
          .addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const doctor = document.getElementById('editDoctor').value;
            const date = document.getElementById('editDate').value;
            try {
              await apiReq(`/file/${id}`, 'PUT', { doctor, date });
              showToast('updated');
              closeModal('editModal');
              await loadFiles();
            } catch (e) {
              showToast('update failed', 'error');
            }
          });

        // preview
        window.previewFile = async (id) => {
          const file = allFiles.find((f) => f.id === id);
          if (!file) return;
          currentPreviewId = id;
          currentPage = 1;
          pdfDoc = null;
          document.getElementById('previewModal').classList.remove('hidden');
          document.getElementById('previewFilename').innerText = file.filename;
          document.getElementById('previewContent').innerHTML =
            '<i class="fas fa-spinner fa-pulse"></i>';
          try {
            const res = await fetch(`${API_URL}/file/${id}`);
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            document.getElementById('downloadPreviewBtn').href = url;
            if (file.contentType === 'application/pdf') {
              pdfjsLib.GlobalWorkerOptions.workerSrc =
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
              const loadingTask = pdfjsLib.getDocument(url);
              pdfDoc = await loadingTask.promise;
              renderPdfPage();
              document.getElementById('pdfControls').style.display = 'flex';
            } else if (file.contentType?.startsWith('image')) {
              document.getElementById('previewContent').innerHTML =
                `<img src="${url}" style="max-width:100%; max-height:300px; border-radius:20px;">`;
              document.getElementById('pdfControls').style.display = 'none';
            } else {
              document.getElementById('previewContent').innerHTML =
                '<p>preview not available</p>';
            }
          } catch (e) {
            document.getElementById('previewContent').innerHTML = 'error';
          }
        };
        async function renderPdfPage() {
          if (!pdfDoc) return;
          const page = await pdfDoc.getPage(currentPage);
          const viewport = page.getViewport({
            scale: 1.5,
            rotation: currentRotation,
          });
          const canvas = document.createElement('canvas');
          canvas.className = 'pdf-canvas';
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          await page.render({
            canvasContext: canvas.getContext('2d'),
            viewport,
          }).promise;
          document.getElementById('previewContent').innerHTML = '';
          document.getElementById('previewContent').appendChild(canvas);
          document.getElementById('pageInfo').innerText =
            `${currentPage}/${pdfDoc.numPages}`;
        }
        document
          .getElementById('prevPageBtn')
          ?.addEventListener('click', () => {
            if (pdfDoc && currentPage > 1) {
              currentPage--;
              renderPdfPage();
            }
          });
        document
          .getElementById('nextPageBtn')
          ?.addEventListener('click', () => {
            if (pdfDoc && currentPage < pdfDoc.numPages) {
              currentPage++;
              renderPdfPage();
            }
          });
        document
          .getElementById('rotateLeftBtn')
          ?.addEventListener('click', () => {
            if (pdfDoc) {
              currentRotation = (currentRotation - 90 + 360) % 360;
              renderPdfPage();
            }
          });
        document
          .getElementById('rotateRightBtn')
          ?.addEventListener('click', () => {
            currentRotation = (currentRotation + 90) % 360;
            renderPdfPage();
          });

        // upload
        fab.addEventListener('click', () =>
          document.getElementById('uploadModal').classList.remove('hidden'),
        );
        document
          .getElementById('simulateFileClick')
          ?.addEventListener('click', () =>
            document.getElementById('uploadFileInput').click(),
          );
        document
          .getElementById('uploadFileInput')
          .addEventListener('change', function (e) {
            document.getElementById('fileNameDisplay').innerText =
              this.files[0]?.name || 'choose file';
          });
        document
          .getElementById('uploadForm')
          .addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('uploadFileInput').files[0];
            if (!file) return showToast('select file', 'error');
            if (file.size > 5 * 1024 * 1024)
              return showToast('max 5MB', 'error');
            const uid = localStorage.getItem('userId');
            const doctor = document.getElementById('uploadDoctor').value;
            const date = document.getElementById('uploadDate').value;
            const fd = new FormData();
            fd.append('userId', uid);
            fd.append('doctor', doctor);
            fd.append('date', date);
            fd.append('file', file);
            try {
              await apiReq('/upload', 'POST', fd, true);
              showToast('uploaded');
              closeModal('uploadModal');
              await loadFiles();
            } catch (e) {
              showToast('upload error', 'error');
            }
          });

        // auth listeners
        document
          .getElementById('loginBtn')
          .addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pwd = document.getElementById('loginPassword').value;
            try {
              const res = await apiReq('/auth/login', 'POST', {
                email,
                password: pwd,
              });
              localStorage.setItem('userId', res.id);
              localStorage.setItem('userEmail', res.email);
              showDashboard();
              await loadFiles();
            } catch (err) {
              showToast('login failed', 'error');
            }
          });
        document
          .getElementById('signupBtn')
          .addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const pwd = document.getElementById('signupPassword').value;
            try {
              const res = await apiReq('/auth/signup', 'POST', {
                email,
                password: pwd,
              });
              localStorage.setItem('userId', res.id);
              localStorage.setItem('userEmail', res.email);
              showDashboard();
              await loadFiles();
            } catch (e) {
              showToast('signup error', 'error');
            }
          });
        document
          .getElementById('showSignupLink')
          .addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthForm('signup');
          });
        document
          .getElementById('backToLoginLink')
          .addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthForm('login');
          });
        document
          .getElementById('showForgotLink')
          .addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthForm('forgot');
          });
        document
          .getElementById('backToLoginFromForgot')
          .addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthForm('login');
          });
        function toggleAuthForm(form) {
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('signupForm').classList.add('hidden');
          document.getElementById('forgotForm').classList.add('hidden');
          if (form === 'login')
            document.getElementById('loginForm').classList.remove('hidden');
          if (form === 'signup')
            document.getElementById('signupForm').classList.remove('hidden');
          if (form === 'forgot')
            document.getElementById('forgotForm').classList.remove('hidden');
        }
        // forgot password (dev token visible)
        document
          .getElementById('forgotBtn')
          .addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            try {
              const res = await apiReq('/auth/forgot-password', 'POST', {
                email,
              });
              if (res.resetLink) {
                const token = res.resetLink.split('token=')[1];
                document
                  .getElementById('resetDevNotice')
                  .classList.remove('hidden');
                document.getElementById('resetTokenDummy').value = token;
              }
              showToast('reset link generated (dev)');
            } catch (e) {
              showToast('error', 'error');
            }
          });

        // settings change password
        document
          .getElementById('settingsChangePwdBtn')
          .addEventListener('click', async () => {
            const token = document.getElementById('settingsToken').value;
            const pwd = document.getElementById('settingsNewPwd').value;
            if (!token || !pwd)
              return showToast('fill token & password', 'error');
            try {
              await apiReq('/auth/reset-password', 'POST', {
                token,
                password: pwd,
                confirmPassword: pwd,
              });
              showToast('password changed');
            } catch (e) {
              showToast('invalid token', 'error');
            }
          });

        // logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
          localStorage.clear();
          showAuth();
        });

        // clear all
        document
          .getElementById('dangerClearAll')
          .addEventListener('click', async () => {
            if (!confirm('DELETE ALL FILES?')) return;
            const uid = localStorage.getItem('userId');
            try {
              await apiReq(`/files/clear?userId=${uid}`, 'DELETE');
              showToast('all cleared');
              await loadFiles();
            } catch (e) {
              showToast('error', 'error');
            }
          });

        // refresh, search, sort
        document
          .getElementById('refreshBtn')
          ?.addEventListener('click', loadFiles);
        document
          .getElementById('fileSearchInput')
          ?.addEventListener('input', renderFiles);
        document
          .getElementById('sortSelect')
          ?.addEventListener('change', renderFiles);
        document
          .getElementById('quickUpload')
          ?.addEventListener('click', () => fab.click());
        document
          .getElementById('quickExport')
          ?.addEventListener('click', () => {
            const data = {
              user: localStorage.getItem('userEmail'),
              files: allFiles,
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {
              type: 'application/json',
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'neonrx_export.json';
            a.click();
          });

        document
          .querySelectorAll('.nav-item')
          .forEach((btn) =>
            btn.addEventListener('click', (e) =>
              switchSection(e.currentTarget.dataset.section),
            ),
          );
        window.closeModal = (id) =>
          document.getElementById(id).classList.add('hidden');

        // start
        checkAuth();
      })();
    </script>
  </body>
</html>
